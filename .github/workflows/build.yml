name: Build Application with Nuitka

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            arch: amd64
            target: linux_amd64
            manylinux_image: quay.io/pypa/manylinux2014_x86_64
          - os: ubuntu-22.04
            arch: arm64
            target: linux_arm64
            manylinux_image: quay.io/pypa/manylinux2014_aarch64
          - os: windows-latest
            arch: x64
            target: win_amd64
            manylinux_image: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM emulation
        if: runner.os == 'Linux' && matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3

      # --- Linux 构建流程 ---
      - name: Build with Manylinux for Linux
        if: runner.os == 'Linux'
        run: |
          COMMANDS="
            set -ex && \
            echo 'Force refreshing YUM cache and installing Tcl/Tk...' && \
            yum clean all && \
            yum makecache && \
            yum install -y tcl-devel tk-devel && \
            \
            cd /work && \
            /opt/python/cp311-cp311/bin/pip install --upgrade pip nuitka ttkbootstrap && \
            echo 'Extracting static libpython required by Nuitka...' && \
            (cd /opt/_internal && tar xf static-libs-for-embedding-only.tar.xz) && \
            \
            echo 'Starting Nuitka build...' && \
            /opt/python/cp311-cp311/bin/python -m nuitka \
              --onefile \
              --standalone \
              --enable-plugin=tk-inter \
              --tcl-library-dir=/usr/lib64 \
              --tk-library-dir=/usr/lib64 \
              --include-data-file=app/myfont.otf=myfont.otf \
              --output-dir=dist_${{ matrix.target }} \
              app
          "
          docker run --rm \
            -v "$(pwd)":/work \
            ${{ matrix.manylinux_image }} \
            /bin/bash -c "$COMMANDS"

      # --- Windows 构建流程 ---
      - name: Set up Python for Windows
        if: runner.os == 'Windows'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: ${{ matrix.arch }}

      - name: Install Dependencies and Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip nuitka
          pip install ttkbootstrap
          
          python -m nuitka `
            --onefile `
            --standalone `
            --windows-disable-console `
            --enable-plugin=tk-inter `
            --assume-yes-for-downloads `
            --include-data-file=app/myfont.otf=myfont.otf `
            --output-dir=dist_${{ matrix.target }} `
            app

      # --- 上传所有平台的构建产物 ---
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.target }}
          path: |
            dist_${{ matrix.target }}
          if-no-files-found: error

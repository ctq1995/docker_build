name: Build All Platforms (Optimized & Fixed)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # Job 1: Build for Linux (x86_64 and ARM64) with UPX and Cache
  build-linux:
    name: Build Linux ${{ matrix.name }}
    runs-on: ubuntu-latest
    timeout-minutes: 90
    strategy:
      matrix:
        include:
          - name: "x86_64"
            platform: "linux/amd64"
            base_image: "ubuntu:20.04"
            output_name: "DownloadLog-linux-x86_64"
          - name: "ARM64"
            platform: "linux/arm64"
            base_image: "arm64v8/ubuntu:20.04"
            output_name: "DownloadLog-linux-arm64"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64 cross-compilation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Multi-Stage Dockerfile for Build
        run: |
          cat > Dockerfile.build << 'EOF'
          # --- FIX: Define PYTHON_VERSION as a global ARG ---
          ARG PYTHON_VERSION=3.13.2

          # Stage 1: Build Python 3.13.2 from source on Ubuntu 20.04 (Focal)
          ARG BASE_IMAGE=ubuntu:20.04
          FROM ${BASE_IMAGE} AS python-builder
          LABEL stage=python-builder

          ENV TZ=Etc/UTC
          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt-get update && apt-get install -y --no-install-recommends \
              build-essential wget ca-certificates libssl-dev zlib1g-dev libncurses5-dev \
              libncursesw5-dev libreadline-dev libgdbm-dev libdb5.3-dev \
              libsqlite3-dev libbz2-dev libexpat1-dev liblzma-dev tk-dev \
              libffi-dev patchelf tzdata upx && \
              rm -rf /var/lib/apt/lists/*

          WORKDIR /tmp
          # Use the global ARG here
          RUN wget https://www.python.org/ftp/python/$PYTHON_VERSION/Python-$PYTHON_VERSION.tar.xz && \
              tar -xf Python-$PYTHON_VERSION.tar.xz

          # And here
          WORKDIR /tmp/Python-$PYTHON_VERSION
          RUN ./configure --prefix=/opt/python/$PYTHON_VERSION --enable-optimizations --with-lto
          RUN make -j$(nproc) && make altinstall

          # Stage 2: Build the Nuitka application
          FROM ${BASE_IMAGE} AS app-builder
          LABEL stage=app-builder

          ENV TZ=Etc/UTC
          ENV DEBIAN_FRONTEND=noninteractive

          # --- FIX: The COPY command can now correctly use the global ARG ---
          COPY --from=python-builder /opt/python/$PYTHON_VERSION /usr/local/
          COPY --from=python-builder /usr/bin/upx /usr/bin/upx
          
          RUN ln -s /usr/local/bin/python3.13 /usr/local/bin/python

          RUN apt-get update && apt-get install -y --no-install-recommends \
              libsqlite3-0 libssl-dev tk-dev tcl-dev tzdata && \
              rm -rf /var/lib/apt/lists/*
          
          WORKDIR /build
          COPY requirements.txt ./
          COPY app/ ./app/

          RUN python -m pip install --no-cache-dir --upgrade pip
          RUN python -m pip install --no-cache-dir -r requirements.txt
          RUN python -m pip install --no-cache-dir nuitka

          RUN python -m nuitka \
              --standalone \
              --onefile \
              --lto=yes \
              --remove-output \
              --enable-plugin=tk-inter \
              --enable-plugin=upx \
              --linux-icon=app/logico.ico \
              --include-data-file=app/myfont.otf=myfont.otf \
              --output-filename=${build_name} \
              --assume-yes-for-downloads \
              app/DownloadLog.py
          EOF

      - name: Cache Nuitka
        uses: actions/cache@v4
        with:
          path: ~/.nuitka
          key: ${{ runner.os }}-${{ matrix.name }}-nuitka-${{ hashFiles('**/requirements.txt', 'app/DownloadLog.py') }}

      - name: Build Docker Image for ${{ matrix.platform }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.build
          platforms: ${{ matrix.platform }}
          load: true
          tags: py-app-builder:${{ matrix.name }}
          build-args: |
            BASE_IMAGE=${{ matrix.base_image }}
            build_name=${{ matrix.output_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract Binary from Container
        run: |
          mkdir -p final_binary
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v "$(pwd)/final_binary":/output \
            py-app-builder:${{ matrix.name }} \
            sh -c 'cp /build/${{ matrix.output_name }} /output/'

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output_name }}
          path: final_binary/${{ matrix.output_name }}

  # Job 2: Build for Windows x64 with UPX and Cache
  build-windows-x64:
    name: Build Windows x64
    runs-on: windows-latest
    timeout-minutes: 60
    needs: []

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13.2 and Cache Pip
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.2'
          cache: 'pip' # Enable pip cache

      - name: Install UPX
        uses: crazy-max/ghaction-upx@v3
        with:
          install-only: true

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      - name: Cache Nuitka
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\Nuitka\Nuitka
          key: ${{ runner.os }}-nuitka-${{ hashFiles('**/requirements.txt', 'app/DownloadLog.py') }}

      - name: Run Nuitka Build
        run: |
          python -m nuitka `
            --standalone `
            --onefile `
            --lto=yes `
            --remove-output `
            --windows-disable-console `
            --enable-plugin=tk-inter `
            --enable-plugin=upx `
            --windows-icon-from-ico="app/logico.ico" `
            --include-data-file="app/myfont.otf=myfont.otf" `
            --output-filename="DownloadLog-win64" `
            --assume-yes-for-downloads `
            app/DownloadLog.py
        shell: pwsh

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DownloadLog-win64
          path: DownloadLog-win64.exe

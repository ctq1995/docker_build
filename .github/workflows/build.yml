name: Build Python ARM64 Binary (No Docker, Native ARM)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-arm64-binary:
    name: Build Ubuntu ARM64 Binary on Native Runner
    
    # æ ¸å¿ƒä¼˜åŒ– 1: ä½¿ç”¨åŸç”Ÿ ARM64 Runner
    # CORE OPTIMIZATION 1: Use a native ARM64 runner.
    runs-on: ubuntu-latest-arm64
    
    # ç”±äºæ²¡æœ‰ Docker å¼€é”€ï¼Œæ•´ä½“æ—¶é—´ä¼šå¿«å¾ˆå¤š
    timeout-minutes: 60
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          # å®‰è£…ç¼–è¯‘ Python å’Œåº”ç”¨æ‰€éœ€çš„ç³»ç»Ÿåº“
          # Install system libraries required for compiling Python and the application.
          sudo apt-get install -y --no-install-commends \
            build-essential wget curl libssl-dev zlib1g-dev libncurses5-dev \
            libreadline-dev libsqlite3-dev libffi-dev tk-dev tcl-dev ca-certificates patchelf

      - name: Build and Install Python 3.13 from Source
        run: |
          # å› ä¸º Runner è‡ªå¸¦çš„ Python ç‰ˆæœ¬å¯èƒ½ä¸æ»¡è¶³è¦æ±‚ï¼Œæˆ‘ä»¬ä»æºç ç¼–è¯‘å®‰è£…
          # Since the runner's default Python might not meet requirements, we compile and install from source.
          wget https://www.python.org/ftp/python/3.13.2/Python-3.13.2.tgz
          tar -xzf Python-3.13.2.tgz
          cd Python-3.13.2
          # CFLAGS ç”¨äºå¤„ç†ç‰¹å®šè­¦å‘Šï¼Œ--enable-optimizations ä¼šä½¿ç¼–è¯‘å˜æ…¢ä½†è¿è¡Œæ€§èƒ½æ›´å¥½
          # CFLAGS handles specific warnings; --enable-optimizations slows compilation but improves runtime performance.
          CFLAGS="-Wno-stringop-truncation" ./configure --prefix=/usr/local --enable-optimizations
          make -j$(nproc)
          sudo make altinstall
          # éªŒè¯å®‰è£…æˆåŠŸ
          # Verify the installation.
          /usr/local/bin/python3.13 --version

      - name: Cache and Install Python Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
        # ä½¿ç”¨æ–°å®‰è£…çš„ Python æ¥å®‰è£… Nuitka å’Œå…¶ä»–ä¾èµ–
        # Use the newly installed Python to install Nuitka and other dependencies.
      - run: |
          /usr/local/bin/python3.13 -m pip install --upgrade pip
          /usr/local/bin/python3.13 -m pip install nuitka -r requirements.txt

      - name: Locate Tcl/Tk Libraries and Run Nuitka
        id: nuitka_build
        run: |
          # æ ¸å¿ƒä¼˜åŒ– 2: ä½¿ç”¨ Shell è„šæœ¬æ›¿ä»£ Python è„šæœ¬æ¥æŸ¥æ‰¾ Tcl/Tk è·¯å¾„
          # CORE OPTIMIZATION 2: Use a shell script instead of a Python script to find Tcl/Tk paths.
          TCL_DIR=""
          TK_DIR=""
          POSSIBLE_PATHS=("/usr/share/tcltk" "/usr/lib/aarch64-linux-gnu" "/usr/lib")
          
          echo "Searching for Tcl/Tk 8.6 libraries..."
          for path in "${POSSIBLE_PATHS[@]}"; do
            if [ -d "${path}/tcl8.6" ] && [ -z "$TCL_DIR" ]; then
              TCL_DIR="${path}/tcl8.6"
              echo "Found Tcl library at: $TCL_DIR"
            fi
            if [ -d "${path}/tk8.6" ] && [ -z "$TK_DIR" ]; then
              TK_DIR="${path}/tk8.6"
              echo "Found Tk library at: $TK_DIR"
            fi
          done

          if [ -z "$TCL_DIR" ] || [ -z "$TK_DIR" ]; then
            echo "âŒ FATAL: Could not find Tcl and/or Tk library paths. Aborting build."
            exit 1
          fi

          # æ ¸å¿ƒä¼˜åŒ– 3: ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ Nuitka
          # CORE OPTIMIZATION 3: Execute Nuitka directly from the command line.
          echo "ğŸš€ Running Nuitka command..."
          /usr/local/bin/python3.13 -m nuitka \
            --onefile \
            --standalone \
            --enable-plugin=tk-inter \
            --tcl-library-dir=${TCL_DIR} \
            --tk-library-dir=${TK_DIR} \
            --include-data-dir=${TCL_DIR}=$(basename ${TCL_DIR}) \
            --include-data-dir=${TK_DIR}=$(basename ${TK_DIR}) \
            --include-data-file=app/myfont.otf=myfont.otf \
            --output-dir=dist \
            --assume-yes-for-downloads \
            app/DownloadLog.py

      - name: Prepare and Verify Artifact
        run: |
          echo "--- Preparing and verifying final artifact ---"
          # Nuitka ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶åä¸å…¥å£è„šæœ¬åç›¸åŒ
          # The executable name generated by Nuitka matches the entry script name.
          SOURCE_BINARY="dist/DownloadLog.py"
          TARGET_BINARY="DownloadLog-ubuntu-arm64-py313"
          
          if [ -f "$SOURCE_BINARY" ]; then
            mv "$SOURCE_BINARY" "$TARGET_BINARY"
            echo "âœ… Binary successfully created and renamed to $TARGET_BINARY"
            file "$TARGET_BINARY"
            ls -lh "$TARGET_BINARY"
          else
            echo "âŒ FATAL: Nuitka output binary not found at $SOURCE_BINARY!"
            # åˆ—å‡º dist ç›®å½•å†…å®¹ä»¥å¸®åŠ©è°ƒè¯•
            ls -lha dist/
            exit 1
          fi

      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: DownloadLog-ubuntu-arm64-py313
          path: DownloadLog-ubuntu-arm64-py313

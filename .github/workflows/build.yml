name: Build All Platforms (Python 3.13.2)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # Job 1: Build for Linux (x86_64 and ARM64) using a Matrix
  build-linux:
    name: Build Linux ${{ matrix.name }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      matrix:
        include:
          - name: "x86_64"
            platform: "linux/amd64"
            base_image: "ubuntu:20.04"
            output_name: "DownloadLog-linux-x86_64"
          - name: "ARM64"
            platform: "linux/arm64"
            base_image: "arm64v8/ubuntu:20.04"
            output_name: "DownloadLog-linux-arm64"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64 cross-compilation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Multi-Stage Dockerfile for Build
        run: |
          cat > Dockerfile.build << 'EOF'
          # =================================================================================
          # Stage 1: Build Python 3.13.2 from source on Ubuntu 20.04 (Focal)
          # This ensures compatibility with older GLIBC (2.31)
          # The base image is dynamically provided by the build matrix.
          # =================================================================================
          ARG BASE_IMAGE=ubuntu:20.04
          FROM ${BASE_IMAGE} AS python-builder
          LABEL stage=python-builder

          ENV PYTHON_VERSION=3.13.2
          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt-get update && apt-get install -y --no-install-recommends \
              build-essential wget ca-certificates libssl-dev zlib1g-dev libncurses5-dev \
              libncursesw5-dev libreadline-dev libgdbm-dev libdb5.3-dev \
              libsqlite3-dev libbz2-dev libexpat1-dev liblzma-dev tk-dev \
              libffi-dev patchelf && \
              rm -rf /var/lib/apt/lists/*

          WORKDIR /tmp
          RUN wget https://www.python.org/ftp/python/$PYTHON_VERSION/Python-$PYTHON_VERSION.tar.xz && \
              tar -xf Python-$PYTHON_VERSION.tar.xz

          WORKDIR /tmp/Python-$PYTHON_VERSION
          # Configure with optimizations and LTO for smaller binary size
          RUN ./configure --prefix=/opt/python/$PYTHON_VERSION --enable-optimizations --with-lto
          RUN make -j$(nproc) && make altinstall

          # =================================================================================
          # Stage 2: Build the Nuitka application using the custom-built Python
          # =================================================================================
          FROM ${BASE_IMAGE} AS app-builder
          LABEL stage=app-builder

          ENV PYTHON_VERSION=3.13.2
          ENV DEBIAN_FRONTEND=noninteractive
          
          # Copy the custom Python build from the previous stage
          COPY --from=python-builder /opt/python/$PYTHON_VERSION /usr/local/
          RUN ln -s /usr/local/bin/python3.13 /usr/local/bin/python

          # Install runtime dependencies for the app
          RUN apt-get update && apt-get install -y --no-install-recommends \
              libsqlite3-0 libssl-dev tk-dev tcl-dev && \
              rm -rf /var/lib/apt/lists/*
          
          WORKDIR /build
          COPY requirements.txt ./
          COPY DownloadLog.py ./
          COPY myfont.otf ./

          # Install Nuitka and dependencies
          RUN python -m pip install --no-cache-dir --upgrade pip
          RUN python -m pip install --no-cache-dir -r requirements.txt
          RUN python -m pip install --no-cache-dir nuitka

          # Run Nuitka with size optimization flags
          RUN python -m nuitka \
              --standalone \
              --onefile \
              --lto=yes \
              --remove-output \
              --enable-plugin=tk-inter \
              --include-data-file=myfont.otf=myfont.otf \
              --output-filename=${{ matrix.output_name }} \
              --assume-yes-for-downloads \
              DownloadLog.py
          EOF

      - name: Build Docker Image for ${{ matrix.platform }}
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --build-arg BASE_IMAGE=${{ matrix.base_image }} \
            --load \
            --progress=plain \
            -f Dockerfile.build \
            -t py-app-builder:${{ matrix.name }} \
            .

      - name: Extract Binary from Container
        run: |
          mkdir -p final_binary
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v "$(pwd)/final_binary":/output \
            py-app-builder:${{ matrix.name }} \
            sh -c 'cp /build/${{ matrix.output_name }} /output/'

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output_name }}
          path: final_binary/${{ matrix.output_name }}

  # Job 2: Build for Windows x64
  build-windows-x64:
    name: Build Windows x64
    runs-on: windows-latest
    timeout-minutes: 60
    # This job runs in parallel with the Linux job
    needs: []

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13.2
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.2'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      - name: Run Nuitka Build
        run: |
          python -m nuitka `
            --standalone `
            --onefile `
            --lto=yes `
            --remove-output `
            --windows-disable-console `
            --enable-plugin=tk-inter `
            --include-data-file="myfont.otf=myfont.otf" `
            --output-filename="DownloadLog-win64" `
            --assume-yes-for-downloads `
            DownloadLog.py
        shell: pwsh

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DownloadLog-win64
          path: DownloadLog-win64.exe

name: Fixed Python 3.13.2 ARM64 Build - Final

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-python313-final:
    name: Build Python 3.13.2 ARM64 - Final
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Create Fixed Dockerfile
        run: |
          cat > Dockerfile.python313-final << 'EOF'
          # 第一阶段：构建 Python 3.13.2
          FROM ubuntu:20.04 AS python-builder
          
          ENV DEBIAN_FRONTEND=noninteractive
          ENV PYTHONUNBUFFERED=1
          
          # 安装构建依赖
          RUN apt-get update && apt-get install -y \
              build-essential \
              wget \
              curl \
              libssl-dev \
              zlib1g-dev \
              libncurses5-dev \
              libreadline-dev \
              libsqlite3-dev \
              libffi-dev \
              tk-dev \
              tcl-dev \
              tcl8.6 \
              tk8.6 \
              blt \
              ca-certificates \
              && rm -rf /var/lib/apt/lists/*
          
          WORKDIR /tmp
          RUN wget https://www.python.org/ftp/python/3.13.2/Python-3.13.2.tgz \
              && tar -xzf Python-3.13.2.tgz \
              && cd Python-3.13.2 \
              && ./configure --prefix=/usr/local --enable-optimizations \
              && make -j$(nproc) \
              && make altinstall
          
          RUN /usr/local/bin/python3.13 --version \
              && /usr/local/bin/python3.13 -m ensurepip --upgrade
          
          # 第二阶段：构建应用
          FROM ubuntu:20.04 AS app-builder
          
          ENV DEBIAN_FRONTEND=noninteractive
          
          RUN apt-get update && apt-get install -y \
              python3 \
              python3-tk \
              tcl8.6 \
              tk8.6 \
              blt \
              libsqlite3-0 \
              libssl1.1 \
              build-essential \
              && rm -rf /var/lib/apt/lists/*
          
          COPY --from=python-builder /usr/local /usr/local
          
          WORKDIR /app
          COPY requirements.txt ./
          COPY app/ ./app/
          COPY app/myfont.otf ./
          
          RUN /usr/local/bin/python3.13 -m pip install --upgrade pip \
              && /usr/local/bin/python3.13 -m pip install -r requirements.txt \
              && /usr/local/bin/python3.13 -m pip install nuitka
          
          # 创建 Python 脚本来查找路径并构建
          RUN cat > build_app.py << 'BUILD_SCRIPT'
          import os
          import subprocess
          import sys
          
          def find_tcl_tk_paths():
              """查找 Tcl/Tk 路径"""
              possible_tcl_paths = [
                  '/usr/lib/tcl8.6',
                  '/usr/lib/x86_64-linux-gnu/tcl8.6',
                  '/usr/lib/aarch64-linux-gnu/tcl8.6',
                  '/usr/share/tcl8.6'
              ]
              
              possible_tk_paths = [
                  '/usr/lib/tk8.6',
                  '/usr/lib/x86_64-linux-gnu/tk8.6',
                  '/usr/lib/aarch64-linux-gnu/tk8.6',
                  '/usr/share/tk8.6'
              ]
              
              tcl_dir = None
              tk_dir = None
              
              # 查找 Tcl
              for path in possible_tcl_paths:
                  if os.path.exists(path):
                      tcl_dir = path
                      break
              
              # 查找 Tk
              for path in possible_tk_paths:
                  if os.path.exists(path):
                      tk_dir = path
                      break
              
              # 如果标准路径不存在，搜索整个系统
              if not tcl_dir or not tk_dir:
                  for root, dirs, files in os.walk('/usr'):
                      for d in dirs:
                          if d.startswith('tcl8.') and not tcl_dir:
                              tcl_dir = os.path.join(root, d)
                          elif d.startswith('tk8.') and not tk_dir:
                              tk_dir = os.path.join(root, d)
          
              return tcl_dir, tk_dir
          
          def main():
              print("=== Building Python Application ===")
              
              # 查找 Tcl/Tk 路径
              tcl_dir, tk_dir = find_tcl_tk_paths()
              
              print(f"TCL_DIR: {tcl_dir}")
              print(f"TK_DIR: {tk_dir}")
              
              if not tcl_dir or not tk_dir:
                  print("ERROR: Could not find Tcl/Tk paths")
                  sys.exit(1)
              
              # 构建 Nuitka 命令
              cmd = [
                  '/usr/local/bin/python3.13', '-m', 'nuitka',
                  '--onefile',
                  '--standalone',
                  '--enable-plugin=tk-inter',
                  '--tcl-library-dir', tcl_dir,
                  '--tk-library-dir', tk_dir,
                  '--include-data-dir', f'{tcl_dir}={os.path.basename(tcl_dir)}',
                  '--include-data-dir', f'{tk_dir}={os.path.basename(tk_dir)}',
                  '--include-data-file', 'myfont.otf=myfont.otf',
                  '--output-dir', 'dist',
                  '--assume-yes-for-downloads',
                  'app/DownloadLog.py'
              ]
              
              print("Running command:", ' '.join(cmd))
              
              # 执行构建
              result = subprocess.run(cmd, capture_output=True, text=True)
              
              if result.returncode != 0:
                  print("ERROR: Nuitka build failed")
                  print("STDOUT:", result.stdout)
                  print("STDERR:", result.stderr)
                  sys.exit(1)
              
              print("=== Build Successful ===")
              print("Output files:")
              os.system('ls -la dist/')
          
          if __name__ == '__main__':
              main()
          BUILD_SCRIPT
          
          # 运行构建脚本
          RUN /usr/local/bin/python3.13 build_app.py
          
          # 验证构建结果
          RUN file dist/*.bin && ls -la dist/
          
          RUN mkdir -p /output && cp dist/*.bin /output/
          
          # 第三阶段：运行时镜像
          FROM ubuntu:20.04 AS runtime
          
          ENV DEBIAN_FRONTEND=noninteractive
          
          RUN apt-get update && apt-get install -y \
              tcl8.6 \
              tk8.6 \
              blt \
              libsqlite3-0 \
              && rm -rf /var/lib/apt/lists/*
          
          WORKDIR /app
          COPY --from=app-builder /output/ ./
          RUN chmod +x *.bin
          CMD ["./DownloadLog.bin"]
          EOF

      - name: Build Final Docker Image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --load \
            -f Dockerfile.python313-final \
            -t python313-arm64-final \
            .

      - name: Extract Binary
        run: |
          mkdir -p dist_final
          docker run --rm \
            -v "$(pwd)/dist_final":/host_output \
            python313-arm64-final \
            sh -c "cp /app/*.bin /host_output/ 2>/dev/null || cp /output/*.bin /host_output/ 2>/dev/null || true"

      - name: Verify Binary
        run: |
          echo "=== Final Verification ==="
          if ls dist_final/*.bin 1> /dev/null 2>&1; then
            file dist_final/*.bin
            ls -lh dist_final/*.bin
            echo "✅ Build completed successfully!"
          else
            echo "❌ No binary found"
            ls -la dist_final/
          fi

      - name: Upload Final Binary
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-ubuntu20.04_arm64_python313_final
          path: dist_final/*

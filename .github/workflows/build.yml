name: Build Application with Nuitka

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            arch: amd64
            target: linux_amd64
            # <<<--- 修改点 1: 使用包含 Python 3.13 的 manylinux 镜像
            manylinux_image: quay.io/pypa/manylinux_2_28_x86_64
          - os: ubuntu-22.04
            arch: arm64
            target: linux_arm64
            # <<<--- 修改点 1: 使用包含 Python 3.13 的 manylinux 镜像
            manylinux_image: quay.io/pypa/manylinux_2_28_aarch64
          - os: windows-latest
            arch: x64
            target: win_amd64
            manylinux_image: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM emulation
        if: runner.os == 'Linux' && matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3

      # --- Linux 构建流程 ---
      - name: Build with Manylinux for Linux
        if: runner.os == 'Linux'
        run: |
          # 使用多行字符串定义在Docker容器内执行的命令
          COMMANDS="
            set -ex && \
            echo 'Force refreshing YUM cache and installing Tcl/Tk...' && \
            yum clean all && \
            yum makecache && \
            yum install -y tcl-devel tk-devel && \
            \
            cd /work && \
            # <<<--- 修改点 2: 更新容器内的 Python 路径到 3.13
            echo 'Upgrading pip...' && \
            /opt/python/cp313-cp313/bin/pip install --upgrade pip && \
            \
            echo 'Installing project dependencies from requirements.txt...' && \
            /opt/python/cp313-cp313/bin/pip install -r requirements.txt && \
            \
            echo 'Installing Nuitka...' && \
            /opt/python/cp313-cp313/bin/pip install nuitka && \
            \
            echo 'Extracting static libpython required by Nuitka...' && \
            # <<<--- 修改点 3: 更新静态库的解压路径
            (cd /opt/python/cp313-cp313 && tar xf Python-3.13.tgz) && \
            \
            echo 'Starting Nuitka build...' && \
            /opt/python/cp313-cp313/bin/python -m nuitka \
              --onefile \
              --standalone \
              --enable-plugin=tk-inter \
              --tcl-library-dir=/usr/lib64 \
              --tk-library-dir=/usr/lib64 \
              --include-module=cryptography \
              --include-data-file=app/myfont.otf=myfont.otf \
              --output-dir=dist_${{ matrix.target }} \
              app
          "
          docker run --rm \
            -v "$(pwd)":/work \
            ${{ matrix.manylinux_image }} \
            /bin/bash -c "$COMMANDS"

      # --- Windows 构建流程 ---
      - name: Set up Python for Windows
        if: runner.os == 'Windows'
        uses: actions/setup-python@v5
        with:
          # <<<--- 修改点 4: 更新 Python 版本
          python-version: '3.13.2'
          architecture: ${{ matrix.arch }}

      - name: Install Dependencies and Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host 'Upgrading pip...'
          python -m pip install --upgrade pip
          
          Write-Host 'Installing project dependencies from requirements.txt...'
          pip install -r requirements.txt
          
          Write-Host 'Installing Nuitka...'
          pip install nuitka
          
          Write-Host 'Starting Nuitka build...'
          python -m nuitka `
            --onefile `
            --standalone `
            --windows-disable-console `
            --enable-plugin=tk-inter `
            --assume-yes-for-downloads `
            --include-module=cryptography `
            --include-data-file=app/myfont.otf=myfont.otf `
            --output-dir=dist_${{ matrix.target}} `
            app

      # --- 上传所有平台的构建产物 ---
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.target }}
          path: |
            dist_${{ matrix.target}}
          if-no-files-found: error

name: Multi-Stage Docker Build with Python 3.13.2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  docker-multi-stage:
    name: Multi-Stage Docker Build Python 3.13.2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Create Multi-stage Dockerfile
        run: |
          cat > Dockerfile.python313-arm64 << 'EOF'
          # 阶段1: 构建 Python 3.13.2
          FROM --platform=linux/arm64 ubuntu:20.04 as python-builder
          
          ENV DEBIAN_FRONTEND=noninteractive
          ENV PYTHONUNBUFFERED=1
          
          # 安装构建依赖
          RUN apt-get update && apt-get install -y \
              build-essential \
              wget \
              curl \
              libssl-dev \
              zlib1g-dev \
              libncurses5-dev \
              libncursesw5-dev \
              libreadline-dev \
              libsqlite3-dev \
              libgdbm-dev \
              libdb5.3-dev \
              libbz2-dev \
              libexpat1-dev \
              liblzma-dev \
              libffi-dev \
              tk-dev \
              tcl-dev \
              tcl \
              tk \
              && rm -rf /var/lib/apt/lists/*
          
          # 编译 Python 3.13.2
          WORKDIR /tmp
          RUN wget https://www.python.org/ftp/python/3.13.2/Python-3.13.2.tgz && \
              tar -xzf Python-3.13.2.tgz && \
              cd Python-3.13.2 && \
              ./configure \
                  --prefix=/usr/local \
                  --enable-optimizations \
                  --enable-loadable-sqlite-extensions \
                  --with-ensurepip=install && \
              make -j$(nproc) && \
              make altinstall
          
          # 验证安装
          RUN /usr/local/bin/python3.13 --version && \
              /usr/local/bin/python3.13 -m ensurepip --upgrade
          
          # 阶段2: 构建应用
          FROM --platform=linux/arm64 ubuntu:20.04 as app-builder
          
          ENV DEBIAN_FRONTEND=noninteractive
          
          # 安装运行时和构建依赖
          RUN apt-get update && apt-get install -y \
              python3 \
              python3-tk \
              tcl8.6 \
              tk8.6 \
              build-essential \
              wget \
              curl && \
              rm -rf /var/lib/apt/lists/*
          
          # 复制编译好的 Python 3.13.2
          COPY --from=python-builder /usr/local /usr/local
          
          # 设置工作目录
          WORKDIR /app
          
          # 复制项目文件
          COPY requirements.txt .
          COPY app/ ./app/
          COPY app/myfont.otf ./
          
          # 安装项目依赖
          RUN /usr/local/bin/python3.13 -m pip install --upgrade pip && \
              /usr/local/bin/python3.13 -m pip install -r requirements.txt && \
              /usr/local/bin/python3.13 -m pip install nuitka
          
          # 查找 Tcl/Tk 路径
          RUN echo "TCL_DIR=$(find /usr -name 'tcl8.*' -type d | head -1)" > /tmp/paths.txt && \
              echo "TK_DIR=$(find /usr -name 'tk8.*' -type d | head -1)" >> /tmp/paths.txt
          
          # 构建应用
          RUN source /tmp/paths.txt && \
              /usr/local/bin/python3.13 -m nuitka \
                  --onefile \
                  --standalone \
                  --enable-plugin=tk-inter \
                  --tcl-library-dir=$TCL_DIR \
                  --tk-library-dir=$TK_DIR \
                  --include-data-dir=$TCL_DIR=$(basename $TCL_DIR) \
                  --include-data-dir=$TK_DIR=$(basename $TK_DIR) \
                  --include-data-file=myfont.otf=app/myfont.otf \
                  --output-dir=dist \
                  --assume-yes-for-downloads \
                  app/DownloadLog.py
          
          # 阶段3: 创建最终运行时镜像
          FROM --platform=linux/arm64 ubuntu:20.04 as runtime
          
          ENV DEBIAN_FRONTEND=noninteractive
          
          # 只安装运行时依赖
          RUN apt-get update && apt-get install -y \
              tcl8.6 \
              tk8.6 \
              libsqlite3-0 \
              libssl1.1 \
              libreadline8 \
              libgdbm6 \
              libdb5.3 \
              libbz2-1.0 \
              liblzma5 \
              libffi7 && \
              rm -rf /var/lib/apt/lists/*
          
          WORKDIR /app
          
          # 复制构建好的二进制文件
          COPY --from=app-builder /app/dist/*.bin .
          
          # 复制必要的系统库
          COPY --from=app-builder /usr/lib/aarch64-linux-gnu/libsqlite3.so.0 /usr/lib/aarch64-linux-gnu/
          COPY --from=app-builder /usr/lib/aarch64-linux-gnu/libssl.so.1.1 /usr/lib/aarch64-linux-gnu/
          COPY --from=app-builder /usr/lib/aarch64-linux-gnu/libcrypto.so.1.1 /usr/lib/aarch64-linux-gnu/
          
          ENTRYPOINT ["./DownloadLog.bin"]
          EOF

      - name: Build Docker Image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --load \
            -f Dockerfile.python313-arm64 \
            -t python313-arm64-app \
            .

      - name: Extract Binary from Docker Image
        run: |
          # 创建容器并提取二进制文件
          docker run --rm \
            -v "$(pwd)/dist_ubuntu20.04_arm64_python313":/output \
            python313-arm64-app \
            cp /app/DownloadLog.bin /output/

      - name: Verify Binary
        run: |
          echo "=== Verifying ARM64 Binary ==="
          file dist_ubuntu20.04_arm64_python313/DownloadLog.bin
          ls -lh dist_ubuntu20.04_arm64_python313/
          
          # 检查依赖
          ldd dist_ubuntu20.04_arm64_python313/DownloadLog.bin | head -10

      - name: Upload Final Binary
        uses: actions/upload-artifact@v4
        with:
          name: app-ubuntu20.04_arm64_python313_final
          path: dist_ubuntu20.04_arm64_python313/*.bin

name: Cross-Compile ARM64 for Ubuntu 20.04

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-arm64-cross:
    name: Cross-Compile for Ubuntu 20.04 ARM64
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Cross-Compilation Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            python3.10-dev \
            python3.10-venv \
            qemu-user-static \
            binfmt-support

      - name: Download Ubuntu 20.04 ARM64 Rootfs
        run: |
          # 下载 Ubuntu 20.04 ARM64 基础系统
          mkdir -p ubuntu20.04-arm64
          cd ubuntu20.04-arm64
          
          # 下载 Ubuntu 20.04 ARM64 base
          wget http://cdimage.ubuntu.com/ubuntu-base/releases/20.04/release/ubuntu-base-20.04.6-base-arm64.tar.gz
          tar -xzf ubuntu-base-20.04.6-base-arm64.tar.gz
          
          # 设置 QEMU 模拟器
          sudo cp /usr/bin/qemu-aarch64-static usr/bin/
          
          # 安装必要的包
          sudo chroot . /bin/bash -c "
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y python3 python3-pip python3-dev python3-tk tcl tk tcl-dev tk-dev build-essential
          "

      - name: Build ARM64 with Cross-Compilation
        run: |
          # 创建交叉编译环境
          mkdir -p build-arm64
          cd build-arm64
          
          # 创建虚拟环境
          python3.10 -m venv cross-env
          source cross-env/bin/activate
          
          # 安装 Nuitka
          pip install --upgrade pip
          pip install nuitka
          pip install -r ../requirements.txt
          
          # 设置交叉编译环境变量
          export CC=aarch64-linux-gnu-gcc
          export CXX=aarch64-linux-gnu-g++
          export AR=aarch64-linux-gnu-ar
          export STRIP=aarch64-linux-gnu-strip
          export PYTHONPATH=$(pwd)/../ubuntu20.04-arm64/usr/lib/python3/dist-packages:$PYTHONPATH
          
          # 复制目标系统的 Tcl/Tk 库
          mkdir -p target-tcl
          cp -r ../ubuntu20.04-arm64/usr/share/tcl* target-tcl/
          cp -r ../ubuntu20.04-arm64/usr/share/tk* target-tcl/
          cp -r ../ubuntu20.04-arm64/usr/lib/aarch64-linux-gnu/tcl* target-tcl/
          
          # 使用 Nuitka 交叉编译
          python -m nuitka \
            --onefile \
            --standalone \
            --enable-plugin=tk-inter \
            --target-arch=arm64 \
            --python-flag=no_warnings \
            --include-data-dir=../ubuntu20.04-arm64/usr/share/tcl8.6=tcl8.6 \
            --include-data-dir=../ubuntu20.04-arm64/usr/share/tk8.6=tk8.6 \
            --include-data-file=../app/myfont.otf=myfont.otf \
            --output-dir=dist_ubuntu20.04_arm64 \
            --assume-yes-for-downloads \
            ../app/DownloadLog.py

      - name: Test ARM64 Binary
        run: |
          # 在 QEMU 中测试二进制文件
          sudo apt-get install -y qemu-user-static
          
          # 创建测试环境
          mkdir -p test-env
          cp dist_ubuntu20.04_arm64/*.bin test-env/
          cp -r ubuntu20.04-arm64/usr/lib/aarch64-linux-gnu test-env/lib
          
          # 注册 QEMU 模拟器
          sudo update-binfmts --enable qemu-aarch64
          
          # 测试运行
          cd test-env
          sudo chroot . /qemu-aarch64-static ./DownloadLog.bin --help || echo "Test completed (may fail without X11)"

      - name: Upload ARM64 Binary
        uses: actions/upload-artifact@v4
        with:
          name: app-ubuntu20.04_arm64
          path: dist_ubuntu20.04_arm64/*.bin

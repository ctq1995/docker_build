name: Build Application with Nuitka

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            arch: amd64
            target: linux_amd64
            manylinux_image: quay.io/pypa/manylinux2014_x86_64
          - os: ubuntu-22.04
            arch: arm64
            target: linux_arm64
            manylinux_image: quay.io/pypa/manylinux2014_aarch64
          - os: windows-latest
            arch: x64
            target: win_amd64
            manylinux_image: "" # Windows 不需要

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Linux 构建流程 (使用 Manylinux Docker) ---
      - name: Build with Manylinux for Linux
        if: runner.os == 'Linux'
        run: |
          # 定义要在 Docker 容器内执行的命令
          # 注意：/opt/python/cp311-cp311/bin/ 是 manylinux 镜像中 Python 3.11 的路径
          COMMANDS="
          cd /work &&
          /opt/python/cp311-cp311/bin/pip install --upgrade pip nuitka ttkbootstrap &&
          /opt/python/cp311-cp311/bin/python -m nuitka \
            --onefile \
            --standalone \
            --enable-plugin=tk-inter \
            --include-data-file=app/myfont.otf=myfont.otf \
            --output-dir=dist_${{ matrix.target }} \
            app/__main__.py
          "
          # 运行 Docker 容器，并将当前目录挂载到容器的 /work 目录
          # 这样，容器内生成的文件就会出现在我们的 Runner 文件系统中
          docker run --rm \
            -v "$(pwd)":/work \
            ${{ matrix.manylinux_image }} \
            /bin/bash -c "$COMMANDS"

      # --- Windows 构建流程 (保持原样) ---
      - name: Setup Python, Install Dependencies and Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # 1. 设置 Python (Windows需要在这里单独设置)
          & "C:\actions\python\setup-python.ps1" -architecture ${{ matrix.arch }} -python-version '3.11'
          
          # 2. 安装依赖
          python -m pip install --upgrade pip
          pip install ttkbootstrap
          
          # 3. 升级 Nuitka
          python -m pip install --upgrade nuitka
          
          # 4. 运行构建
          python -m nuitka `
            --onefile `
            --standalone `
            --windows-disable-console `
            --enable-plugin=tk-inter `
            --include-data-file=app/myfont.otf=myfont.otf `
            --output-dir=dist_${{ matrix.target }} `
            --accept-all-questions `
            app/__main__.py

      # --- 上传所有平台的构建产物 ---
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.target }}
          path: |
            dist_${{ matrix.target }}
          if-no-files-found: error

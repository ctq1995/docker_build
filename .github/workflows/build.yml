name: Build Python ARM64 Binary (Cross-Compilation - Optimized)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-arm64-binary:
    name: Build Ubuntu ARM64 Binary via Cross-Compilation
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64 cross-compilation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Python Build Script for Nuitka
        run: |
          cat > build_app.py << 'BUILD_SCRIPT'
          import os
          import subprocess
          import sys
          
          def find_tcl_tk_paths():
              possible_tcl_paths = ['/usr/share/tcltk/tcl8.6', '/usr/lib/aarch64-linux-gnu/tcl8.6']
              possible_tk_paths = ['/usr/share/tcltk/tk8.6', '/usr/lib/aarch64-linux-gnu/tk8.6']
              tcl_dir = next((path for path in possible_tcl_paths if os.path.isdir(path)), None)
              tk_dir = next((path for path in possible_tk_paths if os.path.isdir(path)), None)
              return tcl_dir, tk_dir
          
          def main():
              print("=== Starting Python Application Build using Nuitka (for ARM64) ===")
              tcl_dir, tk_dir = find_tcl_tk_paths()
              if not tcl_dir or not tk_dir:
                  print("‚ùå FATAL: Could not find Tcl/Tk library paths.")
                  sys.exit(1)
              print(f"‚úÖ Found Tcl library at: {tcl_dir}")
              print(f"‚úÖ Found Tk library at: {tk_dir}")
              
              cmd = [
                  'python3.13', '-m', 'nuitka',
                  '--onefile', '--standalone', '--enable-plugin=tk-inter',
                  '--low-memory', '--show-progress', '--verbose',
                  f'--tcl-library-dir={tcl_dir}', f'--tk-library-dir={tk_dir}',
                  f'--include-data-dir={tcl_dir}={os.path.basename(tcl_dir)}',
                  f'--include-data-dir={tk_dir}={os.path.basename(tk_dir)}',
                  '--include-data-file=app/myfont.otf=myfont.otf',
                  '--assume-yes-for-downloads',
                  'app/DownloadLog.py'
              ]
              
              print("\nüöÄ Running Nuitka command:\n" + ' '.join(cmd) + "\n")
              try:
                  process = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True, bufsize=1)
                  for line in iter(process.stdout.readline, ''):
                      print(line, end='')
                  process.wait()
                  if process.returncode != 0:
                      raise subprocess.CalledProcessError(process.returncode, cmd)
                  
                  print("\n‚úÖ Nuitka build successful!")
                  print("\n--- Files in current directory ---")
                  os.system('ls -lha')
                  print("\n--- Files in dist directory ---")
                  os.system('ls -lha dist/ 2>/dev/null || echo "No dist directory"')
                  print("\n--- Looking for compiled binary ---")
                  os.system('find . -type f -name "*DownloadLog*" ! -name "*.py" -exec ls -lh {} \;')
              except subprocess.CalledProcessError as e:
                  print(f"‚ùå FATAL: Nuitka build failed with exit code {e.returncode}!")
                  sys.exit(e.returncode)
          
          if __name__ == '__main__':
              main()
          BUILD_SCRIPT

      - name: Create Optimized Multi-Stage Dockerfile
        run: |
          cat > Dockerfile.build << 'EOF'
          FROM arm64v8/python:3.13-slim-bookworm AS app-builder
          LABEL stage=app-builder
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update && apt-get install -y --no-install-recommends \
              build-essential tk-dev tcl-dev blt libsqlite3-0 libssl-dev patchelf \
              && rm -rf /var/lib/apt/lists/*
          WORKDIR /build
          COPY requirements.txt ./
          COPY app/ ./app/
          COPY build_app.py ./
          RUN python3.13 -m pip install --no-cache-dir --upgrade pip \
              && python3.13 -m pip install --no-cache-dir -r requirements.txt \
              && python3.13 -m pip install --no-cache-dir nuitka
          RUN python3.13 build_app.py
          RUN echo "=== Final check of build artifacts ===" \
              && ls -lha /build/ \
              && echo "=== Searching for binary ===" \
              && find /build -type f -name "*DownloadLog*" ! -name "*.py"
          EOF

      - name: Build Docker Image for ARM64
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --load \
            --progress=plain \
            -f Dockerfile.build \
            -t py-app-builder:latest \
            .

      - name: Debug - Check Build Output in Container
        run: |
          echo "=== Checking container file structure ==="
          docker run --rm py-app-builder:latest sh -c "
            echo '--- /build directory ---' && ls -lha /build/ && 
            echo '--- /build/dist directory ---' && ls -lha /build/dist/ 2>/dev/null || echo 'No dist directory' &&
            echo '--- Searching for all DownloadLog binaries ---' && 
            find /build -type f -name '*DownloadLog*' ! -name '*.py' -exec ls -lh {} \;
          "

      - name: Extract Binary from Container
        run: |
          set -e
          mkdir -p final_binary
          
          echo "=== Extracting binary from container ==="
          docker run --rm \
            -v "$(pwd)/final_binary":/output \
            py-app-builder:latest \
            sh -c '
              # ÊêúÁ¥¢ÊâÄÊúâÂèØËÉΩÁöÑ‰ΩçÁΩÆ
              BINARY_PATH=$(find /build -type f \( -name "DownloadLog.bin" -o -name "DownloadLog" \) ! -name "*.py" | head -n 1)
              
              if [ -n "$BINARY_PATH" ]; then
                echo "‚úÖ Found binary at: $BINARY_PATH"
                ls -lh "$BINARY_PATH"
                cp "$BINARY_PATH" /output/DownloadLog-ubuntu-arm64
                echo "‚úÖ Binary copied successfully"
              else
                echo "‚ùå Could not find compiled binary!"
                echo "All DownloadLog files found:"
                find /build -name "*DownloadLog*"
                exit 1
              fi
            '

      - name: Verify Final Binary
        run: |
          echo "=== Verifying final artifact ==="
          if [ -f final_binary/DownloadLog-ubuntu-arm64 ]; then
            echo "‚úÖ Binary successfully extracted!"
            ls -lh final_binary/DownloadLog-ubuntu-arm64
            file final_binary/DownloadLog-ubuntu-arm64 2>/dev/null || echo "file command not available"
            chmod +x final_binary/DownloadLog-ubuntu-arm64
            echo "‚úÖ Binary size: $(du -h final_binary/DownloadLog-ubuntu-arm64 | cut -f1)"
          else
            echo "‚ùå FATAL: Binary not found after extraction!"
            echo "Contents of final_binary directory:"
            ls -lha final_binary/
            exit 1
          fi

      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: DownloadLog-ubuntu-arm64-py313
          path: final_binary/DownloadLog-ubuntu-arm64

name: Corrected Python 3.13.2 ARM64 Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-python313-corrected:
    name: Build Python 3.13.2 ARM64 (Corrected)
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Create Python Build Script
        id: create_script
        run: |
          cat > build_app.py << 'BUILD_SCRIPT'
          import os
          import subprocess
          import sys

          def find_tcl_tk_paths():
              """ robustly finds Tcl/Tk paths for Nuitka. """
              # Standard paths for Ubuntu 20.04
              possible_paths = [
                  '/usr/lib/tcl8.6',
                  '/usr/lib/tk8.6',
                  '/usr/lib/aarch64-linux-gnu/tcl8.6',
                  '/usr/lib/aarch64-linux-gnu/tk8.6',
                  '/usr/share/tcltk/tcl8.6',
                  '/usr/share/tcltk/tk8.6',
              ]
              
              tcl_dir = None
              tk_dir = None

              for path in possible_paths:
                  if os.path.exists(path) and 'tcl' in path and not tcl_dir:
                      tcl_dir = path
                  if os.path.exists(path) and 'tk' in path and not tk_dir:
                      tk_dir = path

              if not tcl_dir or not tk_dir:
                  print("Standard paths not found, searching filesystem...")
                  # Fallback search if standard paths fail
                  for root, dirs, files in os.walk('/usr'):
                      if not tcl_dir and 'tcl8.6' in dirs:
                          tcl_dir = os.path.join(root, 'tcl8.6')
                      if not tk_dir and 'tk8.6' in dirs:
                          tk_dir = os.path.join(root, 'tk8.6')

              return tcl_dir, tk_dir

          def main():
              print("=== Starting Python Application Build ===")
              
              tcl_dir, tk_dir = find_tcl_tk_paths()
              
              if not tcl_dir or not tk_dir:
                  print("âŒ ERROR: Could not find Tcl/Tk library paths. Aborting.")
                  sys.exit(1)
              
              print(f"âœ… Found Tcl library at: {tcl_dir}")
              print(f"âœ… Found Tk library at: {tk_dir}")
              
              cmd = [
                  '/usr/local/bin/python3.13', '-m', 'nuitka',
                  '--onefile',
                  '--standalone',
                  '--enable-plugin=tk-inter',
                  '--tcl-library-dir=' + tcl_dir,
                  '--tk-library-dir=' + tk_dir,
                  '--include-data-dir=' + f'{tcl_dir}={os.path.basename(tcl_dir)}',
                  '--include-data-dir=' + f'{tk_dir}={os.path.basename(tk_dir)}',
                  '--include-data-file=myfont.otf=app/myfont.otf',
                  '--output-dir=dist',
                  '--assume-yes-for-downloads',
                  'app/DownloadLog.py'
              ]
              
              print("\nðŸš€ Running Nuitka command:\n" + ' '.join(cmd) + "\n")
              
              result = subprocess.run(cmd, capture_output=True, text=True)
              
              if result.returncode != 0:
                  print("âŒ ERROR: Nuitka build failed!")
                  print("\n--- STDOUT ---\n", result.stdout)
                  print("\n--- STDERR ---\n", result.stderr)
                  sys.exit(1)
              
              print("âœ… Nuitka build successful!")
              print("\n--- STDOUT ---\n", result.stdout)
              print("\n--- Files in dist directory ---")
              os.system('ls -lha dist/')
          
          if __name__ == '__main__':
              main()
          BUILD_SCRIPT

      - name: Create Corrected Dockerfile
        id: create_dockerfile
        run: |
          cat > Dockerfile.corrected << 'EOF'
          # Stage 1: Build Python
          FROM ubuntu:20.04 AS python-builder
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update && apt-get install -y \
              build-essential wget curl libssl-dev zlib1g-dev libncurses5-dev \
              libreadline-dev libsqlite3-dev libffi-dev tk-dev tcl-dev \
              && rm -rf /var/lib/apt/lists/*
          WORKDIR /tmp
          RUN wget https://www.python.org/ftp/python/3.13.2/Python-3.13.2.tgz \
              && tar -xzf Python-3.13.2.tgz \
              && cd Python-3.13.2 \
              && ./configure --prefix=/usr/local --enable-optimizations \
              && make -j$(nproc) \
              && make altinstall

          # Stage 2: Build the application
          FROM ubuntu:20.04 AS app-builder
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update && apt-get install -y \
              python3-tk tcl8.6 tk8.6 blt libsqlite3-0 libssl1.1 \
              && rm -rf /var/lib/apt/lists/*
          
          COPY --from=python-builder /usr/local /usr/local
          
          WORKDIR /app
          COPY requirements.txt app/ app/myfont.otf ./
          
          # Copy the build script into the image
          COPY build_app.py .
          
          # Install dependencies
          RUN /usr/local/bin/python3.13 -m pip install --upgrade pip \
              && /usr/local/bin/python3.13 -m pip install -r requirements.txt \
              && /usr/local/bin/python3.13 -m pip install nuitka
              
          # Execute the build script
          RUN /usr/local/bin/python3.13 build_app.py

          # Stage 3: Final runtime image
          FROM ubuntu:20.04
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update && apt-get install -y \
              tcl8.6 tk8.6 libsqlite3-0 libssl1.1 \
              && rm -rf /var/lib/apt/lists/*
          
          WORKDIR /app
          COPY --from=app-builder /app/dist/DownloadLog.bin .
          RUN chmod +x DownloadLog.bin
          CMD ["./DownloadLog.bin"]
          EOF

      - name: Build Docker Image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --load \
            -f Dockerfile.corrected \
            -t python313-builder:latest \
            .

      - name: Extract Binary from Image
        run: |
          mkdir -p dist_final
          docker run --rm \
            -v "$(pwd)/dist_final":/output \
            python313-builder:latest \
            cp /app/DownloadLog.bin /output/

      - name: Verify Final Binary
        run: |
          echo "--- Verifying final artifact ---"
          if [ -f dist_final/DownloadLog.bin ]; then
            file dist_final/DownloadLog.bin
            ls -lh dist_final/DownloadLog.bin
            echo "âœ… Binary successfully extracted!"
          else
            echo "âŒ ERROR: Binary not found after build!"
            exit 1
          fi

      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-binary-ubuntu-arm64
          path: dist_final/DownloadLog.bin
